permissions:
  contents: read

name: PR Validation

on: pull_request

jobs:
  docs_only_check:
    name: Check for docs-only change
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      docs_only: ${{ steps.docs_only_check.outputs.docs_only }}
    steps:
    - name: Check out code
      uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b #v3.2.0
    - id: files
      name: Get changed files
      uses: tj-actions/changed-files@0626c3f94002c0a9d7491dd7fed7055bbdff6f92 #v35.1.0
      with:
        files_ignore: '**.md'
    - id: docs_only_check
      if: steps.files.outputs.any_changed != 'true'
      name: Check for docs-only changes
      run: echo "docs_only=true" >> $GITHUB_OUTPUT

  tests:
    name: file-checks
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b #v3.2.0
        with:
          fetch-depth: 0
      - name: trailing space
        uses: chainguard-dev/actions/trailing-space@main
      - name: eof-check
        uses: chainguard-dev/actions/eof-newline@main

  fmt:
    name: go-tests
    runs-on: ubuntu-latest
    needs:
      - docs_only_check
    if: (needs.docs_only_check.outputs.docs_only != 'true')
    steps:
      - name: Clone the code
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b #v3.2.0
        with:
           fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version-file: "go.mod"
          check-latest: true
      - name: go fmt
        uses: chainguard-dev/actions/gofmt@main
        with:
          args: "-s"

  go-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repo
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b #v3.2.0
      - name: Setup go
        uses: actions/setup-go@v3
        with:
          go-version-file: "go.mod"
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3.4.0
        with:
          version: "v1.50.2"
