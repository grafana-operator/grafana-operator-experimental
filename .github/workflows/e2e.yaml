name: KinD End-to-End

on:
  pull_request:
    branches: [master]

env:
  NAME: grafana-operator
  NAMESPACE: grafana-operator-system

jobs:
  end-to-end:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repo and checkout submodules
        uses: actions/checkout@v3.3.0
        with:
          submodules: recursive

      - uses: actions/setup-go@v3
        with:
          go-version-file: "go.mod"
          cache: true

      - uses: ko-build/setup-ko@v0.6
        with:
          version: v0.13.0

      - name: Set up KinD
        id: kind
        run: |
          kind create cluster --image=kindest/node:v1.25.3 --config tests/e2e/kind.yaml

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2.4.1

      - name: Build and load (current arch)
        env:
          KO_DOCKER_REPO: ko.local/grafana-operator/grafana-operator
        run: |
          ko build --sbom=none --bare
          kind load docker-image "$KO_DOCKER_REPO"

      - name: Run e2e
        shell: bash
        run: |
          # install kuttl
          make kuttl
          # Run e2e
          VERSION=latest make e2e

      - name: Debug failure
        if: failure()
        run: |
          kubectl version
          kubectl -n $NAMESPACE get all
          kubectl -n $NAMESPACE get grafana
          kubectl get crd
          POD=$(kubectl get pods -n $NAMESPACE -l control-plane=controller-manager --output=jsonpath={.items..metadata.name})
          kubectl logs -n $NAMESPACE $POD -c manager
